{% extends 'base.html' %}
{% block title %}Dashboard | WhatsApp Onboarding{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}
{% block content %}
<div class="row justify-content-center g-4">
  <!-- Left Column: Uploads -->
  <div class="col-lg-6">
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 1</span><i class="bi bi-upload me-2"></i>Upload Business Documents</h4>
      <form method="POST" enctype="multipart/form-data" class="mb-3">
        {{ form.hidden_tag() }}
        <div class="row g-3">
          <div class="col-md-6">
            {{ form.pan_file.label(class_="form-label") }}
            {{ form.pan_file(class_="form-control") }}
          </div>
          <div class="col-md-6">
            {{ form.gst_file.label(class_="form-label") }}
            {{ form.gst_file(class_="form-control") }}
          </div>
        </div>
        <div class="d-grid mt-3">
          {{ form.submit(class_="btn btn-main btn-lg") }}
        </div>
      </form>
      {% if docs_uploaded %}
        <div class="alert alert-success mt-2">Documents uploaded. Please proceed with WhatsApp Setup.</div>
      {% else %}
        <div class="alert alert-info mt-2">Upload both PAN and GST to continue.</div>
      {% endif %}
    </div>
    <div class="card p-4 fade-in mb-4">
      <h5 class="mb-3"><i class="bi bi-folder2-open me-2"></i>Your Uploaded Documents</h5>
      {% if uploads %}
      <ul class="list-group">
        {% for upload in uploads %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ upload.filetype }}</span>
            <span class="fw-bold">{{ upload.filename }}</span>
          </li>
        {% endfor %}
      </ul>
      {% else %}
        <div class="text-muted">No documents uploaded yet.</div>
      {% endif %}
    </div>
  </div>
  <!-- Right Column: WhatsApp -->
  <div class="col-lg-6">
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 2</span><i class="bi bi-whatsapp me-2"></i>WhatsApp Business Setup</h4>
      {% if not docs_uploaded %}
        <div class="alert alert-warning">Please upload your business documents to enable WhatsApp onboarding.</div>
        <button class="btn btn-outline-secondary btn-lg mb-2" disabled>Start WhatsApp Setup via Meta</button>
      {% elif onboarding_status != 'Verified' %}
        <p>Connect your WhatsApp Business Account to enable messaging features.</p>
        <a href="{{ url_for('main.start_onboarding') }}" class="btn btn-outline-success btn-lg mb-2">
          <i class="bi bi-link-45deg me-1"></i>Start WhatsApp Setup via Meta
        </a>
        <div class="mt-2">
          <span class="badge bg-info">Status: {{ onboarding_status }}</span>
        </div>
      {% else %}
        <div class="alert alert-success">WhatsApp onboarding complete! You can now send messages.</div>
        <div class="mt-2">
          <span class="badge bg-success">Status: {{ onboarding_status }}</span>
        </div>
      {% endif %}
    </div>
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 3</span><i class="bi bi-chat-dots me-2"></i>Send WhatsApp Test Message</h4>
      {% if can_send %}
      <form method="POST" action="{{ url_for('main.send_message') }}" class="mb-2">
        {{ msg_form.hidden_tag() }}
        <div class="row g-2">
          <div class="col-md-6">
            {{ msg_form.recipient.label(class_="form-label") }}
            {{ msg_form.recipient(class_="form-control") }}
          </div>
          <div class="col-md-6">
            {{ msg_form.template.label(class_="form-label") }}
            {{ msg_form.template(class_="form-select") }}
          </div>
        </div>
        <div class="d-grid mt-3">
          {{ msg_form.submit(class_="btn btn-main btn-lg") }}
        </div>
      </form>
      {% else %}
        <div class="alert alert-info">Complete WhatsApp onboarding to enable messaging.</div>
        <button class="btn btn-outline-secondary btn-lg mb-2" disabled>Send Message</button>
      {% endif %}
    </div>
    {% if onboarding_status == 'Verified' %}
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 4</span><i class="bi bi-file-earmark-plus me-2"></i>Manage Message Templates</h4>
      <p>Create and manage your WhatsApp message templates for approval and use.</p>
      <a href="{{ url_for('main.manage_templates') }}" class="btn btn-outline-primary btn-lg mb-2">
        <i class="bi bi-pencil-square me-1"></i>Manage Templates
      </a>
    </div>
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 5</span><i class="bi bi-clock-history me-2"></i>Message History</h4>
      {% if message_history %}
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th scope="col">Sent At</th>
              <th scope="col">Recipient</th>
              <th scope="col">Template</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for msg in message_history %}
            <tr>
              <td>{{ msg.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td>{{ msg.recipient }}</td>
              <td>{{ msg.template_id }}</td>
              <td>
                {% if msg.status == 'delivered' %}
                  <span class="badge bg-success">Delivered</span>
                {% elif msg.status == 'read' %}
                  <span class="badge bg-info">Read</span>
                {% elif msg.status == 'failed' %}
                  <span class="badge bg-danger">Failed</span>
                {% else %}
                  <span class="badge bg-secondary">{{ msg.status|capitalize }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-muted">No messages sent yet.</div>
      {% endif %}
    </div>
    {% else %}
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 4</span><i class="bi bi-file-earmark-plus me-2"></i>Manage Message Templates</h4>
      <div class="alert alert-warning mb-0">You must complete WhatsApp onboarding before managing templates.</div>
    </div>
    <div class="card p-4 fade-in mb-4">
      <h4 class="mb-3"><span class="badge bg-primary me-2">Step 5</span><i class="bi bi-clock-history me-2"></i>Message History</h4>
      <div class="alert alert-warning mb-0">You must complete WhatsApp onboarding before viewing message history.</div>
    </div>
    {% endif %}
    <div class="text-end mt-3">
      <a href="{{ url_for('main.logout') }}" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right me-1"></i>Logout</a>
    </div>
  </div>
</div>
{% endblock %} 