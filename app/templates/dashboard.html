{% extends 'base.html' %}
{% block title %}Dashboard - WaBridge{% endblock %}

{% block content %}
<div class="container">
  <!-- Welcome Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="fw-bold mb-1">Welcome back!</h1>
          <p class="text-muted mb-0">{{ current_user.email }}</p>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary">
            <i class="bi bi-box-arrow-right me-1"></i>Logout
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Overview -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-light border-0 p-4">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h5 class="fw-bold mb-2">Account Status</h5>
            {% if onboarding_status == 'Verified' %}
            <p class="text-success mb-0">
              <i class="bi bi-check-circle-fill me-2"></i>
              Your WhatsApp Business account is active and ready to send messages!
            </p>
            {% elif onboarding_status == 'In Progress' %}
            <p class="text-warning mb-0">
              <i class="bi bi-clock-fill me-2"></i>
              WhatsApp setup is in progress. Complete the steps below to start messaging.
            </p>
            {% else %}
            <p class="text-info mb-0">
              <i class="bi bi-info-circle-fill me-2"></i>
              Let's get your WhatsApp Business account set up in just a few steps.
            </p>
            {% endif %}
          </div>
          <div class="col-md-4 text-end">
            <span
              class="badge bg-{{ 'success' if onboarding_status == 'Verified' else 'warning' if onboarding_status == 'In Progress' else 'info' }} fs-6 px-3 py-2">
              {{ onboarding_status }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row g-4 mb-5">
    <!-- Send Message -->
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 text-center p-4">
        <div class="feature-icon mx-auto mb-3">
          <i class="bi bi-send-fill"></i>
        </div>
        <h5 class="fw-bold mb-3">Send Message</h5>
        <p class="text-muted mb-4">Send WhatsApp messages to individual customers</p>
        {% if can_send %}
        <a href="{{ url_for('main.send_messages') }}" class="btn btn-primary">
          <i class="bi bi-send me-2"></i>Send Now
        </a>
        {% else %}
        <button class="btn btn-outline-secondary" disabled>
          Complete Setup First
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Bulk Messages -->
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 text-center p-4">
        <div class="feature-icon mx-auto mb-3">
          <i class="bi bi-broadcast"></i>
        </div>
        <h5 class="fw-bold mb-3">Bulk Messages</h5>
        <p class="text-muted mb-4">Send messages to multiple customers at once</p>
        {% if can_send %}
        <a href="{{ url_for('main.bulk_messages') }}" class="btn btn-primary">
          <i class="bi bi-broadcast me-2"></i>Send Bulk
        </a>
        {% else %}
        <button class="btn btn-outline-secondary" disabled>
          Complete Setup First
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Templates -->
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 text-center p-4">
        <div class="feature-icon mx-auto mb-3">
          <i class="bi bi-file-text-fill"></i>
        </div>
        <h5 class="fw-bold mb-3">Message Templates</h5>
        <p class="text-muted mb-4">Create and manage your message templates</p>
        <div class="d-grid gap-2">
          {% if onboarding_status == 'Verified' %}
          <a href="{{ url_for('main.template_library') }}" class="btn btn-primary">
            <i class="bi bi-collection me-2"></i>Browse Templates
          </a>
          <a href="{{ url_for('main.manage_templates') }}" class="btn btn-outline-primary">
            <i class="bi bi-gear me-2"></i>Manage My Templates
          </a>
          {% else %}
          <button class="btn btn-outline-secondary" disabled>
            Complete Setup First
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Schedule Messages -->
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 text-center p-4">
        <div class="feature-icon mx-auto mb-3">
          <i class="bi bi-clock"></i>
        </div>
        <h5 class="fw-bold mb-3">Schedule Messages</h5>
        <p class="text-muted mb-4">Schedule messages to be sent at specific times</p>
        {% if can_send %}
        <a href="{{ url_for('main.schedule_messages') }}" class="btn btn-primary">
          <i class="bi bi-clock me-2"></i>Schedule
        </a>
        {% else %}
        <button class="btn btn-outline-secondary" disabled>
          Complete Setup First
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Analytics -->
    <div class="col-md-6 col-lg-3">
      <div class="card h-100 text-center p-4">
        <div class="feature-icon mx-auto mb-3">
          <i class="bi bi-graph-up"></i>
        </div>
        <h5 class="fw-bold mb-3">Analytics</h5>
        <p class="text-muted mb-4">View detailed insights and performance metrics</p>
        <div class="d-grid gap-2">
          {% if onboarding_status == 'Verified' %}
          <a href="{{ url_for('main.analytics') }}" class="btn btn-primary">
            <i class="bi bi-graph-up me-2"></i>View Analytics
          </a>
          <a href="{{ url_for('main.message_history') }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-clock-history me-1"></i>Message History
          </a>
          {% else %}
          <button class="btn btn-outline-secondary" disabled>
            Complete Setup First
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Setup Steps (only show if not verified) -->
  {% if onboarding_status != 'Verified' %}
  <div class="row">
    <div class="col-12">
      <div class="card p-4">
        <h4 class="fw-bold mb-4">
          <i class="bi bi-list-check me-2"></i>
          Complete Your Setup
        </h4>

        <!-- Step 1: Documents (simplified - make optional) -->
        <div class="d-flex align-items-start mb-4 pb-4 border-bottom">
          <div class="step-number me-3 {{ 'bg-success' if docs_uploaded else 'bg-secondary' }}">
            {% if docs_uploaded %}
            <i class="bi bi-check"></i>
            {% else %}
            1
            {% endif %}
          </div>
          <div class="flex-grow-1">
            <h6 class="fw-bold mb-2">Business Verification (Optional)</h6>
            <p class="text-muted mb-3">Upload business documents for higher message limits</p>
            {% if not docs_uploaded %}
            <a href="{{ url_for('main.business_verification') }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-upload me-1"></i>Upload Documents
            </a>
            <button class="btn btn-link btn-sm text-muted">Skip for now</button>
            {% else %}
            <span class="badge bg-success">
              <i class="bi bi-check me-1"></i>Documents uploaded
            </span>
            {% endif %}
          </div>
        </div>

        <!-- Step 2: WhatsApp Setup -->
        <div class="d-flex align-items-start mb-4">
          <div
            class="step-number me-3 {{ 'bg-success' if onboarding_status == 'Verified' else 'bg-primary' if onboarding_status == 'In Progress' else 'bg-secondary' }}">
            {% if onboarding_status == 'Verified' %}
            <i class="bi bi-check"></i>
            {% else %}
            2
            {% endif %}
          </div>
          <div class="flex-grow-1">
            <h6 class="fw-bold mb-2">Connect WhatsApp Business</h6>
            <p class="text-muted mb-3">Link your WhatsApp Business account to start messaging</p>
            {% if onboarding_status != 'Verified' %}
            <a href="{{ url_for('main.simple_setup') }}" class="btn btn-primary">
              <i class="bi bi-whatsapp me-2"></i>Connect WhatsApp
            </a>
            {% else %}
            <span class="badge bg-success">
              <i class="bi bi-check me-1"></i>WhatsApp connected
            </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Recent Activity (only show if verified) -->
  {% if onboarding_status == 'Verified' and message_history %}
  <div class="row mt-5">
    <div class="col-12">
      <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-clock-history me-2"></i>
            Recent Messages
          </h5>
          <a href="{{ url_for('main.message_history') }}" class="btn btn-outline-primary btn-sm">
            View All
          </a>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Recipient</th>
                <th>Template</th>
                <th>Status</th>
                <th>Sent</th>
              </tr>
            </thead>
            <tbody>
              {% for msg in message_history[:5] %}
              <tr>
                <td>{{ msg.recipient }}</td>
                <td>Template #{{ msg.template_id }}</td>
                <td>
                  {% if msg.status == 'delivered' %}
                  <span class="badge bg-success">Delivered</span>
                  {% elif msg.status == 'read' %}
                  <span class="badge bg-info">Read</span>
                  {% elif msg.status == 'failed' %}
                  <span class="badge bg-danger">Failed</span>
                  {% else %}
                  <span class="badge bg-secondary">{{ msg.status|capitalize }}</span>
                  {% endif %}
                </td>
                <td class="text-muted">{{ msg.created_at.strftime('%b %d, %Y') }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}