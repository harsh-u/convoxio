{% extends 'base.html' %}
{% block title %}Payment - WaBridge{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      
      <!-- Payment Header -->
      <div class="text-center mb-4">
        <i class="bi bi-credit-card text-primary" style="font-size: 3rem;"></i>
        <h2 class="fw-bold mt-3 mb-2">Complete Your Payment</h2>
        <p class="text-muted">You're upgrading to {{ plan.name }} plan</p>
      </div>

      <!-- Order Summary -->
      <div class="card mb-4">
        <div class="card-header bg-light">
          <h5 class="fw-bold mb-0">
            <i class="bi bi-receipt me-2"></i>
            Order Summary
          </h5>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-8">
              <h6 class="fw-bold mb-1">{{ plan.name }} Plan</h6>
              <p class="text-muted mb-2">{{ "{:,}".format(plan.message_limit) }} messages per month</p>
              <ul class="list-unstyled mb-0 small">
                {% if plan.name == 'Business' %}
                <li><i class="bi bi-check text-success me-1"></i> Bulk messaging</li>
                <li><i class="bi bi-check text-success me-1"></i> Message scheduling</li>
                <li><i class="bi bi-check text-success me-1"></i> Advanced analytics</li>
                <li><i class="bi bi-check text-success me-1"></i> Priority support</li>
                {% elif plan.name == 'Enterprise' %}
                <li><i class="bi bi-check text-success me-1"></i> Everything in Business</li>
                <li><i class="bi bi-check text-success me-1"></i> API access</li>
                <li><i class="bi bi-check text-success me-1"></i> 24/7 phone support</li>
                {% endif %}
              </ul>
            </div>
            <div class="col-4 text-end">
              <h4 class="fw-bold text-primary mb-0">₹{{ plan.price }}</h4>
              <small class="text-muted">per month</small>
            </div>
          </div>
          
          <hr class="my-3">
          
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Total Amount</span>
            <span class="fw-bold h5 text-primary mb-0">₹{{ plan.price }}</span>
          </div>
        </div>
      </div>

      <!-- Payment Button -->
      <div class="card">
        <div class="card-body text-center p-4">
          <h6 class="fw-bold mb-3">
            <i class="bi bi-shield-check text-success me-2"></i>
            Secure Payment with Razorpay
          </h6>
          
          <button id="rzp-button" class="btn btn-primary btn-lg px-5">
            <i class="bi bi-credit-card me-2"></i>
            Pay ₹{{ plan.price }}
          </button>
          
          <div class="mt-3">
            <small class="text-muted">
              <i class="bi bi-lock me-1"></i>
              Your payment information is secure and encrypted
            </small>
          </div>
          
          <div class="mt-3">
            <img src="https://razorpay.com/assets/razorpay-glyph.svg" alt="Razorpay" style="height: 20px; opacity: 0.7;">
            <small class="text-muted ms-2">Powered by Razorpay</small>
          </div>
        </div>
      </div>

      <!-- Money Back Guarantee -->
      <div class="text-center mt-4">
        <div class="card bg-light border-0 p-3">
          <div class="row align-items-center">
            <div class="col-md-4 text-center">
              <i class="bi bi-shield-fill-check text-success" style="font-size: 2rem;"></i>
            </div>
            <div class="col-md-8">
              <h6 class="fw-bold mb-1">30-Day Money Back Guarantee</h6>
              <small class="text-muted">Not satisfied? Get a full refund within 30 days.</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Cancel Link -->
      <div class="text-center mt-3">
        <a href="{{ url_for('main.subscription') }}" class="text-muted text-decoration-none">
          <i class="bi bi-arrow-left me-1"></i>
          Cancel and go back
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('rzp-button');
    
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        const options = {
            "key": "{{ razorpay_key }}",
            "amount": {{ (plan.price * 100)|int }}, // Amount in paise
            "currency": "INR",
            "name": "WaBridge",
            "description": "{{ plan.name }} Plan Subscription",
            "order_id": "{{ order.id }}",
            "handler": function (response) {
                // Create a form and submit payment details
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("main.payment_success") }}';
                
                // Add CSRF token
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrf_token';
                csrfToken.value = '{{ csrf_token() }}';
                form.appendChild(csrfToken);
                
                // Add payment response data
                const fields = ['razorpay_payment_id', 'razorpay_order_id', 'razorpay_signature'];
                fields.forEach(field => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = field;
                    input.value = response[field];
                    form.appendChild(input);
                });
                
                document.body.appendChild(form);
                form.submit();
            },
            "prefill": {
                "name": "{{ current_user.business_name or current_user.email }}",
                "email": "{{ current_user.email }}",
                "contact": "{{ current_user.phone_number or '' }}"
            },
            "notes": {
                "user_id": "{{ current_user.id }}",
                "plan_id": "{{ plan.id }}",
                "plan_name": "{{ plan.name }}"
            },
            "theme": {
                "color": "#25d366"
            },
            "modal": {
                "ondismiss": function() {
                    // Redirect to payment failed page
                    window.location.href = '{{ url_for("main.payment_failed") }}';
                }
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
    });
});
</script>
{% endblock %}